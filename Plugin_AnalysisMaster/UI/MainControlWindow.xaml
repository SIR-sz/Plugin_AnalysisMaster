<Window x:Class="Plugin_AnalysisMaster.UI.MainControlWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="分析大师" Height="700" Width="320" Topmost="True" WindowStyle="None" AllowsTransparency="True" Background="Transparent">

    <Window.Resources>
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="#BBB"/>
        </Style>

        <Style x:Key="ValueInputStyle" TargetType="TextBox">
            <Setter Property="Background" Value="#2D2D2D"/>
            <Setter Property="Foreground" Value="#2196F3"/>
            <Setter Property="BorderBrush" Value="#444"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextAlignment" Value="Right"/>
            <Setter Property="Margin" Value="5,0,0,0"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

        <Style TargetType="GroupBox">
            <Setter Property="BorderBrush" Value="#444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="#2196F3"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupBox">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Border Grid.Row="0" Grid.RowSpan="2" BorderBrush="{TemplateBinding BorderBrush}" 
                                    BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="6"/>
                            <ContentPresenter Grid.Row="0" Margin="10,0,0,0" ContentSource="Header" />
                            <ContentPresenter Grid.Row="1" Margin="{TemplateBinding Padding}" />
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="#333"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#555"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
            <Setter Property="VirtualizingStackPanel.IsVirtualizing" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton Name="ToggleButton" 
                                  BorderBrush="{TemplateBinding BorderBrush}" 
                                  Background="{TemplateBinding Background}"
                                  Foreground="{TemplateBinding Foreground}"
                                  Grid.ColumnSpan="2" Focusable="false" 
                                  IsChecked="{Binding Path=IsDropDownOpen,Mode=TwoWay,RelativeSource={RelativeSource TemplatedParent}}" 
                                  ClickMode="Press">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border Name="Border" CornerRadius="4" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1">
                                            <Path Name="Arrow" Fill="#AAA" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,8,0" Data="M 0 0 L 4 4 L 8 0 Z"/>
                                        </Border>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter Name="ContentSite" IsHitTestVisible="False" Content="{TemplateBinding SelectionBoxItem}"
                                      ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                      ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                      Margin="10,3,23,3" VerticalAlignment="Center" HorizontalAlignment="Left" />
                            <Popup Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsDropDownOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Slide">
                                <Grid Name="DropDown" SnapsToDevicePixels="True" MinWidth="{TemplateBinding ActualWidth}" MaxHeight="{TemplateBinding MaxDropDownHeight}">
                                    <Border Name="DropDownBorder" Background="#2D2D2D" BorderThickness="1" BorderBrush="#555" CornerRadius="2"/>
                                    <ScrollViewer Margin="4,6,4,6" SnapsToDevicePixels="True" VerticalScrollBarVisibility="Auto">
                                        <VirtualizingStackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                                    </ScrollViewer>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="#2D2D2D"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="8,5"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#2196F3"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="Slider">
            <Setter Property="Margin" Value="0,8"/>
            <Style.Resources>
                <SolidColorBrush x:Key="{x:Static SystemColors.ControlLightBrushKey}" Color="#333" />
            </Style.Resources>
        </Style>
    </Window.Resources>

    <Border Background="#1E1E1E" CornerRadius="12" BorderBrush="#333" BorderThickness="1">
        <Border.Effect>
            <DropShadowEffect BlurRadius="15" Color="#AA000000" Direction="270" ShadowDepth="3"/>
        </Border.Effect>

        <Grid Margin="15">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="180"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,10">
                <TextBlock Text="动态曲线助手" Foreground="#E0E0E0" FontSize="15" FontWeight="Bold" VerticalAlignment="Center"/>
                <Button Content="✕" HorizontalAlignment="Right" Width="24" Height="24" Background="Transparent" Foreground="#666" BorderBrush="Transparent" Click="Close_Click"/>
            </Grid>

            <Border Grid.Row="1" Background="#000" CornerRadius="5" BorderBrush="#222" BorderThickness="1">
                <Grid>
                    <Canvas x:Name="PreviewCanvas" ClipToBounds="True"/>

                    <Image x:Name="BlockPreviewImage" Width="60" Height="60" 
               HorizontalAlignment="Right" VerticalAlignment="Bottom" 
               Margin="0,0,10,10" Opacity="0.8" Stretch="Uniform"/>
                </Grid>
            </Border>

            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,10,0,0">
                <StackPanel>
                    <GroupBox Header="绘制模式">
                        <StackPanel>
                            <TextBlock Text="渲染模式" FontSize="11" Margin="5,2,0,0"/>
                            <ComboBox x:Name="PathTypeCombo" SelectionChanged="OnPathTypeChanged" Margin="5,2,5,5">
                                <ComboBoxItem Content="连续线 (Solid)" Tag="Solid" IsSelected="True"/>
                                <ComboBoxItem Content="阵列样式 (Pattern)" Tag="Pattern"/>
                            </ComboBox>

                            <TextBlock Text="骨架类型" FontSize="11" Margin="5,2,0,0"/>
                            <ComboBox x:Name="SkeletonTypeCombo" SelectionChanged="OnParamChanged" Margin="5,2,5,5">
                                <ComboBoxItem Content="平滑曲线 (Spline)" Tag="True" IsSelected="True"/>
                                <ComboBoxItem Content="折线/直角 (Polyline)" Tag="False"/>
                            </ComboBox>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="SolidPanel" Header="宽度配置">
                        <StackPanel>
                            <TextBlock Text="起点宽度" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="StartWidthSlider" Minimum="0.1" Maximum="10000" Value="1.0" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=StartWidthSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F1}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>
                            <TextBlock Text="中点宽度" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="MidWidthSlider" Minimum="0.1" Maximum="10000" Value="0.8" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=MidWidthSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F1}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>
                            <TextBlock Text="终点宽度" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="EndWidthSlider" Minimum="0.1" Maximum="10000" Value="1.0" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=EndWidthSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F1}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="PatternPanel" Header="阵列参数" Visibility="Collapsed">
                        <StackPanel>
                            <TextBlock Text="图元样式 1" FontSize="11" Margin="0,5,0,0"/>
                            <ComboBox x:Name="BlockLibraryCombo" SelectionChanged="OnParamChanged" Margin="0,5"/>

                            <Grid Margin="0,2,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <CheckBox x:Name="CompositeCheckBox" Content="组合模式" Foreground="#2196F3" VerticalAlignment="Center" Click="OnCompositeToggle_Click"/>
                            </Grid>

                            <StackPanel x:Name="CompositeSettingsPanel" Visibility="Collapsed">
                                <TextBlock Text="图元样式 2" FontSize="11" Margin="0,5,0,0"/>
                                <ComboBox x:Name="BlockLibraryCombo2" SelectionChanged="OnParamChanged" Margin="0,5"/>
                            </StackPanel>

                            <TextBlock Text="排列间距" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="SpacingSlider" Minimum="0.1" Maximum="10000" Value="2.0" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=SpacingSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F1}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>

                            <TextBlock Text="单元缩放" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="PatternScaleSlider" Minimum="0.1" Maximum="1000" Value="1.0" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=PatternScaleSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F1}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="端头设置">
                        <StackPanel>
                            <TextBlock Text="起始端" FontSize="11" Margin="0,5,0,0"/>
                            <ComboBox x:Name="StartArrowCombo" SelectionChanged="OnParamChanged" Margin="0,2">
                                <ComboBoxItem Content="无" Tag="None" IsSelected="True"/>
                            </ComboBox>

                            <TextBlock Text="结束端" FontSize="11" Margin="0,5,0,0"/>
                            <ComboBox x:Name="EndArrowCombo" SelectionChanged="OnParamChanged" Margin="0,2">
                                <ComboBoxItem Content="无" Tag="None" IsSelected="True"/>
                            </ComboBox>

                            <TextBlock Text="端头缩放" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="ArrowSizeSlider" Minimum="0.1" Maximum="1000" Value="1.0" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=ArrowSizeSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F1}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>

                            <TextBlock Text="端头缩进" FontSize="11" Margin="0,5,0,0"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="CapIndentSlider" Minimum="-100" Maximum="100" Value="0" ValueChanged="OnParamChanged"/>
                                <TextBox Grid.Column="1" Text="{Binding ElementName=CapIndentSlider, Path=Value, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F0}}" Style="{StaticResource ValueInputStyle}"/>
                            </Grid>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Header="常规设置">
                        <StackPanel>
                            <TextBlock Text="动线颜色" FontSize="11" Margin="0,5,0,0"/>
                            <Rectangle x:Name="ColorPreview" Fill="SteelBlue" Height="25" Cursor="Hand" MouseLeftButtonDown="SelectColor_Click" Margin="0,8" RadiusX="3" RadiusY="3" Stroke="#444"/>
                            <Button Content="管理资源库 (DWG)" Click="OpenLibraryFolder_Click" Height="30" Margin="0,5,0,5" Background="#3D3D3D" Foreground="#2196F3" BorderBrush="#444" FontSize="11">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" CornerRadius="4" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>

            <Grid Grid.Row="3" Margin="0,15,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Button Content="开始绘制" 
                        Click="StartDraw_Click" 
                        Height="35" Margin="0,0,5,0"
                        Background="#2196F3" Foreground="White" FontWeight="Bold">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                </Button>

                <Button Grid.Column="1" 
                        Content="生成图例" 
                        Click="GenerateLegend_Click" 
                        Height="35" Margin="5,0,0,0"
                        Background="#4CAF50" Foreground="White" FontWeight="Bold">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </Grid>
        </Grid>
    </Border>
</Window>